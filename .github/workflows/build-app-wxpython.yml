name: CI - Build wxPython (Practically Perfect in Every Way)

on:
  push:
    branches:
      - macos-next
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    name: Build wxPython (A Spoonful of Sugar Edition)
    runs-on: macos-13

    env:
      # Analytics
      ANALYTICS_KEY: ${{ secrets.ANALYTICS_KEY }}
      ANALYTICS_SITE: ${{ secrets.ANALYTICS_SITE }}

      # App Signing
      ORG_MAC_DEVELOPER_ID_APPLICATION_IDENTITY: ${{ secrets.ORG_MAC_DEVELOPER_ID_APPLICATION_IDENTITY }}

      # PKG Signing
      ORG_MAC_DEVELOPER_ID_INSTALLER_IDENTITY: ${{ secrets.ORG_MAC_DEVELOPER_ID_INSTALLER_IDENTITY }}

      # Notarization
      ORG_MAC_NOTARIZATION_TEAM_ID: ${{ secrets.ORG_MAC_NOTARIZATION_TEAM_ID }}
      ORG_MAC_NOTARIZATION_APPLE_ID: ${{ secrets.ORG_MAC_NOTARIZATION_APPLE_ID }}
      ORG_MAC_NOTARIZATION_PASSWORD: ${{ secrets.ORG_MAC_NOTARIZATION_PASSWORD }}

    steps:
      - name: Check out the repo (Spit Spot!)
        uses: actions/checkout@v4

      - name: Set Git Variables
        id: git_vars
        run: |
          echo "branch=$(echo $GITHUB_REF | sed 's|refs/heads/||')" >> $GITHUB_ENV
          if [ "${GITHUB_EVENT_NAME}" == "push" ]; then
            echo "commiturl=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}" >> $GITHUB_ENV
            echo "commitdate=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
          elif [ "${GITHUB_EVENT_NAME}" == "release" ]; then
            echo "commiturl=${GITHUB_EVENT_RELEASE_HTML_URL}" >> $GITHUB_ENV
            echo "commitdate=${GITHUB_EVENT_RELEASE_PUBLISHED_AT}" >> $GITHUB_ENV
          fi

      - name: Install Python Requirements (Just a Spoonful of Pip)
        run: |
          echo "âœ¨ Installing dependencies to make the magic happen âœ¨"
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          echo "âœ… Requirements installed â€” practically perfect in every way."

      - name: Prepare Assets (--prepare-assets)
        run: |
          echo "â˜‚ï¸ Gathering the carpetbag and umbrella..."
          python3 Build-Project.command --run-as-individual-steps --reset-dmg-cache --prepare-assets
          echo "ðŸª„ Assets prepared â€” spick and span!"

      - name: Prepare Application (--prepare-application)
        run: |
          echo "ðŸŽ¶ Chim chim cher-ee, building the app with glee..."
          python3 Build-Project.command \
            --application-signing-identity "${ORG_MAC_DEVELOPER_ID_APPLICATION_IDENTITY}" \
            --notarization-apple-id "${ORG_MAC_NOTARIZATION_APPLE_ID}" \
            --notarization-password "${ORG_MAC_NOTARIZATION_PASSWORD}" \
            --notarization-team-id "${ORG_MAC_NOTARIZATION_TEAM_ID}" \
            --git-branch "${branch}" \
            --git-commit-url "${commiturl}" \
            --git-commit-date "${commitdate}" \
            --analytics-key "${ANALYTICS_KEY}" \
            --analytics-endpoint "${ANALYTICS_SITE}" \
            --reset-pyinstaller-cache \
            --run-as-individual-steps \
            --prepare-application
          echo "ðŸ’« Application built and polished till it shines!"

      - name: Prepare Package (--prepare-package)
        run: |
          echo "ðŸ§³ Adding build credits to the package..."
          # Create a small text file inside the package to display credits
          echo "Build by Alex, code by dortania" > ./dist/BUILD_CREDITS.txt
          
          echo "ðŸ§³ Tucking everything neatly into the package..."
          python3 Build-Project.command \
            --installer-signing-identity "${ORG_MAC_DEVELOPER_ID_INSTALLER_IDENTITY}" \
            --notarization-apple-id "${ORG_MAC_NOTARIZATION_APPLE_ID}" \
            --notarization-password "${ORG_MAC_NOTARIZATION_PASSWORD}" \
            --notarization-team-id "${ORG_MAC_NOTARIZATION_TEAM_ID}" \
            --additional-files ./dist/BUILD_CREDITS.txt \
            --run-as-individual-steps \
            --prepare-package
          echo "ðŸŽ© Package ready â€” shipshape and Bristol fashion!"

      - name: Upload AutoPkg Package to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AutoPkg-Assets.pkg
          path: ./dist/AutoPkg-Assets.pkg

      - name: Upload Installation Package to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenCore-Patcher.pkg
          path: ./dist/OpenCore-Patcher.pkg

      - name: Upload Uninstaller Package to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenCore-Patcher-Uninstaller.pkg
          path: ./dist/OpenCore-Patcher-Uninstaller.pkg

      - name: Upload Packages to Release
        if: github.event_name == 'release' || github.ref == 'refs/heads/macos-next'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./dist/AutoPkg-Assets.pkg
            ./dist/OpenCore-Patcher.pkg
            ./dist/OpenCore-Patcher-Uninstaller.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
